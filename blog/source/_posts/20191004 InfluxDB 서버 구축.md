---
title: InfluxDB 서버 구축
date: 2019-10-04 18:27:15
tags:
---

LoRa 단말기로부터 데이터를 LoRa App Server에서 확인할 수 있다.
단, 로깅 기능은 없기 때문에 로그를 저장할 데이터베이스 서버를 따로 구축한다.

# InfluxDB 설치
InfluxDB는 외부 종속성이 없는 time-series 데이터베이스이다. 실시간 처리나 시간별로 데이터를 남기는 로깅에 적합하며, REST API 또한 제공해주므로 TCP/IP 요청으로 쉽게 데이터베이스에 접근할 수 있다.
LoRa App Server에서 InfluxDB 서버로 데이터를 자동 전송하는 기능을 제공해주므로 사용하기 매우 적합한 솔루션이라 볼 수 있다.
https://www.influxdata.com/

모든 과정은 우분투 기준으로 작성됐다.

## repository 등록
```
wget -qO- https://repos.influxdata.com/influxdb.key | sudo apt-key add -
source /etc/lsb-release
echo "deb https://repos.influxdata.com/${DISTRIB_ID,,} ${DISTRIB_CODENAME} stable" | sudo tee /etc/apt/sources.list.d/influxdb.list
```


## 설치 및 서비스 시작
```
sudo apt-get update && sudo apt-get install influxdb
sudo service influxdb start
```


## InfluxDB 포트
InfluxDB는 API 통신을 위해 8086 포트를 사용한다.
인터넷과 연결할 때는 보안을 위해 다른 포트로 포워딩을 시켜주었다.

## Lora App Server와 연계
App Server -> Device-profiles -> [my device profile] -> CODEC으로 이동하면 LoRa 단말로부터 수신한 데이터를 App Server단에서 가공하여 데이터베이스 서버로 넘겨줄 수 있다.
Android App에서 사용할 Application Layer Protocol에 맞추어 수신한 바이너리 데이터를 문자열화하여 전송한다.
``` javascript
// Decode decodes an array of bytes into an object.
//  - fPort contains the LoRaWAN fPort number
//  - bytes is an array of bytes, e.g. [225, 230, 255, 0]
// The function must return an object, e.g. {"temperature": 22.5}
function Decode(fPort, bytes) {
  
  var status = bytes[0];
  var latitude_sign = (bytes[4]>>7) & 0x01;
  var latitude_int = (bytes[4] & 0x7F) << 1 | ((bytes[3] >> 7) & 0x01);
  var latitude_dec = (bytes[3] & 0x7F) << 16 | (bytes[2] & 0xFF) << 8 | bytes[1] & 0xFF;
  var latitude_str = "";
  if(latitude_sign == 0) latitude_str += '+';
  else latitude_str += '-';
  latitude_str += latitude_int.toString() + '.' + latitude_dec.toString();

  var longitude_sign = (bytes[8]>>7) & 0x01;
  var longitude_int = (bytes[8] & 0x7F) << 1 | ((bytes[7] >> 7) & 0x01);
  var longitude_dec = (bytes[7] & 0x7F) << 16 | bytes[6] << 8 | bytes[5];
  var longitude_str = "";
  if(longitude_sign == 0) longitude_str += '+';
  else longitude_str += '-';
  longitude_str += longitude_int.toString() + '.' + longitude_dec.toString();
  

  var temperature = (bytes[10] << 8 | bytes[9]);
  var humidity = (bytes[12] << 8 | bytes[11]) / 100;
  if (temperature & 0x8000) {
    temperature = ~temperature + 1;
    temperature &= 0x7FFF;
    temperature *= -1;
  }
  temperature /= 100;
  
  var battery = bytes[13];
  var radiation = (bytes[15] << 8 | bytes[14]) / 100;
  
  return {
      "node0": status.toString() + '/' + latitude_str + '/' + longitude_str + '/' + temperature.toString() + '/' + humidity.toString() + '/' + battery.toString() + '/' + radiation.toString()
  };
}
```
App Server -> Applications -> [my application] -> Integrations로 이동하여 수신한 데이터를 다른 서비스와 연계할 수 있다.
Create 버튼을 누르고 Integration 종류 선택창 중에서 InfluxDB를 선택한다.

데이터베이스 서버의 API endpoint와 Username, Password, Database name를 입력하여 저장한다.

이렇게하여 InfluxDB와 연계되었다.

## 데이터가 저장되는지 확인
{% asset_img image0.png %}